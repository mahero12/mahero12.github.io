<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
<title>Mapa TFG</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
<link rel="stylesheet"
	href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet"
	href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<link rel="stylesheet" href="Css.css" />

</head>

<body>


	<div id="map" style="height: 100vh;"></div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
	<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
	
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>

	<script>
///////////////////////////////////////////////////////GESTIÓN DEL API DE GEONAMES/////////////////////////////////////////////////////////////////////////////
    	// Gestión del API de GeoNames
    	const usuarios = ["mahero8", "mahero9","maherox","mahero123","mahero12","mahero13","mahero16","mahero17","mahero18","mahero19","mahero20","mahero21",];
    	const ficheros = ["JSON/salida10000.json", "JSON/salida2.json"];
    	let puntosUnicos = new Set();
	  	let mapaClases = new Map();

	  	function consultarFicheros() {
	  		for (let i = 0; i < ficheros.length; i++) {
	  			fetch(ficheros[i])
	  			.then(response => response.json())
	  			.then(data => {
	  					for (let item in data.results.bindings) {
	  						let punto = data.results.bindings[item];
	  						let valorPlace = punto.place.value;
	  						let id = valorPlace.split('/')[3];
	  						
	  						if (!puntosUnicos.has(id)) {
	  							puntosUnicos.add(id);
	  						}
	  					}
	  		
	  		            // Carga los marcadores de salida3
	  		            for (var it = puntosUnicos.values(), val = null; val = it.next().value; ) {
	  		                let clase = getClassByPlace(val);
	  		                
	  		                if (clase !== "undefined") {
	  		                	mapaClases.set(val, clase);
	  					    }
	  		  			}
	  			}).catch(error => console.error('Error cargando el archivo JSON:', error));
	  		}

	  		document.getElementsByClassName("menu leaflet-control")[0].style.display = 'block';
	  	}
////////////////////////////////////////////PETICIÓN SÍNCRONA AL API DE GEONAMES/////////////////////////////////////////////////////////////////////////////

	  	// Envía una petición síncrona al API de GeoNames
	  	function getClassByPlace(id) {
	  	  const geonamesAPI = 'https://secure.geonames.org/getJSON';
	  	  let username = usuarios[Math.floor(Math.random() * usuarios.length)];
	  	  const geoNameId = id;
	  	  let url = `${geonamesAPI}?geonameId=${geoNameId}&username=${username}`;     
	  	  var conexion = nuevaConexion();
	  	  conexion.open("GET", url, false);
	  	  conexion.send();      
	  	  return JSON.parse(conexion.responseText).fcl;
	  	}
////////////////////////////////////////////CREAMOS CONEXIÓN PARA LA PETICIÓN /////////////////////////////////////////////////////////////////////////////

	  	// Crea una conexión para enviar una petición con el objeto XMLHttpRequest
	  	function nuevaConexion() {
	  	  var xmlhttp = false;

	  	  try {
	  	    xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
	  	  }
	  	  catch (e) {
	  	    try {
	  	      xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
	  	    } 
	  	    catch (E) { 
	  	      xmlhttp = false;
	  	    }
	  	  }

	  	  if (!xmlhttp && typeof XMLHttpRequest!='undefined') { 
	  	    xmlhttp = new XMLHttpRequest();
	  	  }
	  	  
	  	  return xmlhttp; 
	  	}
///////////////////////////////////////////////////////CREAMOS MAPA Y MARCADORES/////////////////////////////////////////////////////////////////////////////

      var bounds = L.latLngBounds([36.9681, -10.7000], [44.2917, 5.7200]);
      var map = L.map('map').setView([45.4699, -0.3763], 5);
      map.setMinZoom(2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 18,
        maxBounds: bounds
      }).addTo(map);
      
   // Creamos el marcador para el archivo JSON
      const markers = L.markerClusterGroup({
        showCoverageOnHover: false,
        chunkedLoading: true,
        chunkInterval: 100,
        maxClusterRadius: 20, // Limita el número de marcadores en cada clúster
        spiderLegPolylineOptions: { opacity: 0 },
        iconCreateFunction: function(cluster) {
          return L.divIcon({ html: '<b>' + cluster.getChildCount() + '</b>', className: 'myclustericon' });
        }
      });
      markers.addTo(map);

///////////////////////////////////////////////////////CREAMOS MENÚ PRINCIPAL/////////////////////////////////////////////////////////////////////////////
 
	//Creamos el menu

      var Menu = L.Control.extend({
        onAdd: function(map) {
      	  
          // Crea un div para el menú y añade el HTML
          var menuDiv = L.DomUtil.create('div', 'menu');
          menuDiv.innerHTML = `
            <div class="menu-header">
              <h1>Menú</h1>
            </div>
            <ul class="menu-items">
            <li><a onclick="loadJSONAndAddMarkers1(map, 10)" class="boton" role="button">PRIMERA TÉCNICA 10</a>
            <li><a onclick="loadJSONAndAddMarkers1(map, 100)" class="boton" role="button">PRIMERA TÉCNICA 100</a>
            <li><a onclick="loadJSONAndAddMarkers1(map, 1000)" class="boton" role="button">PRIMERA TÉCNICA 1000</a>
            <li><a onclick="loadJSONAndAddMarkersAlert(map, 10)" class="boton" role="button">SEGUNDA TÉCNICA 10</a>
            <li><a onclick="loadJSONAndAddMarkersAlert(map, 100)" class="boton" role="button">SEGUNDA TÉCNICA 100</a>
            <li><a onclick="loadJSONAndAddMarkersAlert(map, 1000)" class="boton" role="button">SEGUNDA TÉCNICA 1000</a>
            <li><a onclick="loadJSONAndAddMarkers3(map, 10)" class="boton" role="button">TERCERA TÉCNICA 10</a>
            <li><a onclick="loadJSONAndAddMarkers3(map, 100)" class="boton" role="button">TERCERA TÉCNICA 100</a>
            <li><a onclick="loadJSONAndAddMarkers3(map, 1000)" class="boton" role="button">TERCERA TÉCNICA 1000</a>
            <li><a onclick="loadJSONAndAddMarkers4(map, 10)" class="boton" role="button">CUARTA TÉCNICA 10</a>
            <li><a onclick="loadJSONAndAddMarkers4(map, 100)" class="boton" role="button">CUARTA TÉCNICA 100</a>
            <li><a onclick="loadJSONAndAddMarkers4(map, 1000)" class="boton" role="button">CUARTA TÉCNICA 1000</a>
            </ul>`;
          return menuDiv;
          
        },
        onRemove: function(map) {}
      });

      // Añade el control personalizado al mapa
      var menu = new Menu({ position: 'topright' }).addTo(map);
      
//////////////////////////////////////////////CREAMOS LEYENDA PARA TÉCNICA 1: NIVEL DE GRANULARIDAD/////////////////////////////////////////////////////////////////////////////

      //creamos la leyenda para nivel de granularidad 
		var legend = L.control({position: 'bottomright'});
		
		// Función para generar el contenido de la leyenda
		legend.onAdd = function (map) {
		  var div = L.DomUtil.create('div', 'leyenda');
		  div.style.display = 'flex';
		  div.style.bottom = '10px';
		  div.innerHTML = 
			'<div class="leyenda-titulo">Leyenda:</div>' +
		    '<div><span class="marker-icon green"></span>Ciudad </div>' +
		    '<div><span class="marker-icon red"></span>País </div>' +
		    '<div><span class="marker-icon orange"></span>Bosque </div>' +
		    '<div><span class="marker-icon yellow"></span>Montaña </div>' +
		    '<div><span class="marker-icon violet"></span>Parque </div>' +
		    '<div><span class="marker-icon white"></span>Carretera </div>' +
		    '<div><span class="marker-icon black"></span>Plaza/Calle </div>' +
		    '<div><span class="marker-icon blue"></span>Agua </div>';
		  return div;
		};

		
//////////////////////////////////////////////CREAMOS MENÚ PARA TÉCNICA 2: NIVEL DE GRANULARIDAD/////////////////////////////////////////////////////////////////////////////

		//creamos la leyenda para nivel de granularidad 2
		var legend4 = L.control({position: 'bottomright'});

		// Función para generar el contenido de la leyenda
		legend4.onAdd = function (map) {
		  var div = L.DomUtil.create('div', 'leyenda1');
		  div.style.display = 'flex';
		  div.style.bottom = '10px';
		  div.innerHTML = 
			'<div class="leyenda-titulo">Seleccione:</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,10, \'P\')"style="background-color: green;"></button>Ciudad</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,10, \'A\')"style="background-color: red;"></button>País</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,10, \'V\')"style="background-color: orange;"></button>Bosque  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,10, \'T\')"style="background-color: yellow;"></button>Montaña  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,10, \'L\')"style="background-color: violet;"></button>Parque  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,10, \'R\')"style="background-color: white;"></button>Carretera  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,10, \'S\')"style="background-color: black;"></button>Plaza/Calle  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,10, \'H\') "style="background-color: blue;"></button>Agua</div>'+
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers21(map,10) "style="background-color: gray;"></button>Todos</div>';
		  return div;
		};

		//creamos la leyenda para nivel de granularidad 2
		var legend100 = L.control({position: 'bottomright'});

		// Función para generar el contenido de la leyenda
		legend100.onAdd = function (map) {
		  var div = L.DomUtil.create('div', 'leyenda1');
		  div.style.display = 'flex';
		  div.style.bottom = '10px';
		  div.innerHTML = 
			'<div class="leyenda-titulo">Seleccione:</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,100, \'P\')"style="background-color: green;"></button>Ciudad</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,100, \'A\')"style="background-color: red;"></button>País</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,100, \'V\')"style="background-color: orange;"></button>Bosque  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,100, \'T\')"style="background-color: yellow;"></button>Montaña  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,100, \'L\')"style="background-color: violet;"></button>Parque  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,100, \'R\')"style="background-color: white;"></button>Carretera  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,100, \'S\')"style="background-color: black;"></button>Plaza/Calle  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,100, \'H\') "style="background-color: blue;"></button>Agua</div>'+
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers21(map,100) "style="background-color: gray;"></button>Todos</div>';
		  return div;
		};
		
		//creamos la leyenda para nivel de granularidad 2
		var legend1000 = L.control({position: 'bottomright'});

		// Función para generar el contenido de la leyenda
		legend1000.onAdd = function (map) {
		  var div = L.DomUtil.create('div', 'leyenda1');
		  div.style.display = 'flex';
		  div.style.bottom = '10px';
		  div.innerHTML = 
			'<div class="leyenda-titulo">Seleccione:</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,1000, \'P\')"style="background-color: green;"></button>Ciudad</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,1000, \'A\')"style="background-color: red;"></button>País</div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,1000, \'V\')"style="background-color: orange;"></button>Bosque  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,1000, \'T\')"style="background-color: yellow;"></button>Montaña  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,1000, \'L\')"style="background-color: violet;"></button>Parque  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,1000, \'R\')"style="background-color: white;"></button>Carretera  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,1000, \'S\')"style="background-color: black;"></button>Plaza/Calle  </div>' +
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers2(map,1000, \'H\') "style="background-color: blue;"></button>Agua</div>'+
		    '<div><button class="marker-button" onclick="loadJSONAndAddMarkers21(map,1000) "style="background-color: gray;"></button>Todos</div>';
		  return div;
		};

////////////////////////////////////////////CREAMOS LEYENDA PARA TÉCNICA 1: MÚLTIPLES LOCALIZACIONES/////////////////////////////////////////////////////////////////////////////

		//creamos la leyenda para múltiples localizaciones 1
		var legend2 = L.control({position: 'bottomright'});
		
		// Función para generar el contenido de la leyenda
		legend2.onAdd = function (map) {
		  var div = L.DomUtil.create('div', 'leyenda2');
		  div.style.display = 'flex';
		  div.style.bottom = '10px';
		  div.innerHTML = 
			'<div class="leyenda-titulo">Leyenda:</div>' +
		    '<div><span class="marker-icon orange"></span>Principal </div>' +
		    '<div><span class="marker-icon yellow"></span>Secundario </div>' +
		    '<div><span class="marker-icon blue"></span>No tiene </div>';
		  return div;
		};
		
////////////////////////////////////////////CREAMOS LEYENDA PARA TÉCNICA 2: MÚLTIPLES LOCALIZACIONES/////////////////////////////////////////////////////////////////////////////

		//creamos la leyenda para múltiples localizaciones 2
		var legend3 = L.control({position: 'bottomright'});
		
		// Función para generar el contenido de la leyenda
		legend3.onAdd = function (map) {
		  var div = L.DomUtil.create('div', 'leyenda3');
		  div.style.display = 'flex';
		  div.style.bottom = '10px';
		  div.innerHTML = 
			'<div class="leyenda-titulo">Leyenda:</div>' +
		    '<div><span class="marker-icon orange"></span>  Principal  </div>' +
		    '<div><span class="marker-icon blue"></span>No tiene</div>' ;
		  return div;
		};

		consultarFicheros();
    </script>
	<script src="TFG.js"></script>
</body>
</html>

